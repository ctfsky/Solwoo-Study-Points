<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÂ≠¶Áîü„Éù„Ç§„É≥„Éà„Çø„Çπ„ÇØ</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF9AA2;
            /* Pastel Pink */
            --secondary-color: #B5EAD7;
            /* Pastel Mint */
            --accent-color: #C7CEEA;
            /* Pastel Purple */
            --text-color: #555;
            --bg-color: #FFF7F3;
            --card-bg: #FFFFFF;
            --shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            /* Friendly Japanese font */
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0, 0, 0, 0.1);
            margin-bottom: 5px;
            /* Reduced margin to bring date closer */
        }

        .header-date {
            font-family: inherit;
            font-size: 1.2rem;
            padding: 8px 20px;
            border: 2px solid var(--accent-color);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-color);
            margin: 10px 0 20px 0;
            text-align: center;
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .header-date:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 154, 162, 0.3);
        }

        .points-display {
            font-size: 3rem;
            font-weight: bold;
            color: #FFB347;
            /* Orange for emphasis */
            background: white;
            padding: 10px 30px;
            border-radius: 50px;
            display: inline-block;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }



        .points-display:hover {
            transform: scale(1.1);
        }

        .panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 3px solid transparent;
            transition: border-color 0.3s;
        }

        .task-panel {
            border-color: var(--secondary-color);
        }

        .store-panel {
            border-color: var(--accent-color);
        }

        h2 {
            color: var(--text-color);
            border-bottom: 2px dashed #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Update input group to handle select */
        select {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            background-color: white;
            transition: border-color 0.3s;
        }

        select:focus {
            border-color: var(--primary-color);
        }

        input {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: var(--primary-color);
        }

        input[type="text"] {
            flex-grow: 2;
        }

        input[type="number"] {
            width: 80px;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: transform 0.1s, background 0.3s;
        }

        button:hover {
            background: #FF8090;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        ul {
            list-style: none;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            transition: transform 0.2s, opacity 0.5s;
        }

        .task-item:hover {
            transform: translateX(5px);
            background: #fff0f5;
        }

        .task-info {
            font-size: 1.1rem;
        }

        .task-points {
            background: var(--secondary-color);
            color: #4CAF50;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-left: 10px;
            font-weight: bold;
        }

        .complete-btn {
            background: var(--secondary-color);
            margin-left: 10px;
        }

        .complete-btn:hover {
            background: #98DBC6;
        }

        .delete-btn {
            background: #ffeba7;
            color: #555;
            margin-left: 5px;
            padding: 4px 10px;
            /* Smaller padding */
            font-size: 0.9rem;
        }

        .delete-btn:hover {
            background: #ffecb3;
            transform: translateY(-2px);
        }

        /* Store Grid */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
        }

        .store-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .store-item:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
            background: #f0f4ff;
        }

        .store-cost {
            color: #FFB347;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }

        .redeem-btn {
            background: var(--accent-color);
            width: 100%;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .redeem-btn:hover {
            background: #A0AEC0;
        }

        .redeem-btn:disabled {
            background: #ddd;
            cursor: not-allowed;
            transform: none;
        }

        /* History List */
        .history-panel {
            border-color: #aaa;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: 0.8rem;
            color: #999;
            margin-right: 10px;
        }

        /* Animations */
        @keyframes pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1);
            }
        }

        .anim-pop {
            animation: pop 0.3s ease-out;
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .anim-slide-out {
            animation: slideOut 0.5s forwards;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Mobile Responsiveness */
        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }

            .input-group {
                flex-direction: column;
            }

            input[type="number"] {
                width: 100%;
            }
        }

        .reset-btn {
            background-color: #fff0f0;
            color: #d32f2f;
            border: 2px solid #ffcdd2;
            padding: 10px 20px;
            font-size: 0.9rem;
            margin-top: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .reset-btn:hover {
            background-color: #ffcdd2;
            transform: translateY(-2px);
        }

        .tool-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: inherit;
        }

        .tool-btn:hover {
            filter: brightness(0.9);
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üåü „Ç≠„É©„Ç≠„É©‚òÜ„Çø„Çπ„ÇØ üåü</h1>
            <div style="display: flex; justify-content: center; width: 100%;">
                <input type="date" id="task-date" class="header-date">
            </div>



            <div class="points-display">
                <span id="points">0</span> üíé
            </div>
        </header>

        <main>
            <section class="panel task-panel">
                <h2>üìù ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ</h2>
                <div class="input-group">
                    <select id="task-select">
                        <option value="custom">ÁßëÁõÆ</option>
                        <option value="ÁÆóÊï∞">ÁÆóÊï∞</option>
                        <option value="ÂõΩË™û">ÂõΩË™û</option>
                        <option value="Ëã±Ë™û">Ëã±Ë™û</option>
                        <option value="Á§æ‰ºö">Á§æ‰ºö</option>
                        <option value="ÁêÜÁßë">ÁêÜÁßë</option>
                        <option value="Â≠¶Ê†°ÂÆøÈ°å">Â≠¶Ê†°ÂÆøÈ°å</option>
                        <option value="Êó•Ë®ò">Êó•Ë®ò</option>
                    </select>
                    <select id="sub-task-select" style="display: none;">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <input type="text" id="task-input" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ...">
                    <input type="hidden" id="task-value" value="10">
                    <button id="add-task-btn">ËøΩÂä†</button>
                </div>
                <ul id="task-list">
                    <!-- Tasks will be added here -->
                </ul>
            </section>

            <section class="panel bonus-panel" style="border-color: #FFD700;">
                <h2>üéâ „Éú„Éº„Éä„Çπ„Éù„Ç§„É≥„Éà</h2>
                <div class="input-group">
                    <select id="bonus-select" style="flex-grow: 1;">
                        <option value="math_basic_perfect">ÁÆóÊï∞Âü∫Á§éÂïèÈ°åÊ∫ÄÁÇπ (10pt)</option>
                        <option value="morning_study">ÊúùÂ≠¶Áøí (20pt)</option>
                        <option value="homework_9pm">Â§ú9ÊôÇ„Åæ„Åß„Å´ÂÆøÈ°å„ÇíÂÖ®ÈÉ®ÂÆåÊàê (20pt)</option>
                        <option value="sapix_c">Sapix C„ÇØ„É©„Çπ„Å´ÊòáÈÄ≤ (100pt)</option>
                        <option value="sapix_d">Sapix D„ÇØ„É©„Çπ„Å´ÊòáÈÄ≤ (300pt)</option>
                        <option value="sapix_alpha">Sapix Œ±„ÇØ„É©„Çπ„ÅÆË∫çÈÄ≤ (500pt)</option>
                    </select>
                    <button id="add-bonus-btn" style="background: #FFD700; color: #555;">„ÅÇ„Åí„ÇãÔºÅ</button>
                </div>
            </section>

            <section class="panel store-panel">
                <h2>üéÅ „Åî„Åª„ÅÜ„Å≥‰∫§Êèõ</h2>

                <div id="store-grid" class="store-grid">
                    <!-- Store items will be added here -->
                </div>
            </section>

            <section class="panel graph-panel">
                <h2>üìà „Ç¨„É≥„Éê„É™Ë®òÈå≤</h2>
                <div style="position: relative; height: 250px;">
                    <canvas id="earningsChart"></canvas>
                </div>
            </section>

            <section class="panel history-panel">
                <h2>ÔøΩ „Çø„Çπ„ÇØÂ±•Ê≠¥</h2>
                <ul id="task-history-list" class="history-list">
                    <!-- Task History items will be added here -->
                </ul>
            </section>

            <section class="panel history-panel">
                <h2>ÔøΩüìú ‰∫§ÊèõÂ±•Ê≠¥</h2>
                <ul id="history-list" class="history-list">
                    <!-- History items will be added here -->
                </ul>
            </section>
        </main>

        <div
            style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button id="export-btn" class="tool-btn">üíæ „Éá„Éº„Çø„Çí‰øùÂ≠ò</button>
            <button id="import-btn" class="tool-btn">üìÇ „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ</button>
            <input type="file" id="import-file" style="display: none;" accept=".json">
            <button id="reset-btn" class="reset-btn" style="margin-top: 0;">‚ö†Ô∏è ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô</button>
        </div>

        <footer>
            <p>ÊØéÊó•„Ç≥„ÉÑ„Ç≥„ÉÑ„Åå„Çì„Å∞„Çç„ÅÜÔºÅüåà</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Management ---
            const defaultData = {
                points: 0,
                tasks: [],
                store: [
                    { id: 'reward_1', text: "Screen Time 10 min", cost: 20 },
                    { id: 'reward_3', text: "ÁâπÂà•„Å™„Åä„ÇÑ„Å§", cost: 50 },
                    { id: 'reward_4', text: "Â•Ω„Åç„Å™Êú¨„ÇíË≤∑„ÅÜ", cost: 100 },
                    { id: 'reward_5', text: "„Ç≤„Éº„É†„ÇΩ„Éï„Éà", cost: 5000 },
                    { id: 'reward_6', text: "PS5ÂÖÖÈõªÂô®", cost: 5000 },
                    { id: 'reward_7', text: "„É¢„Éê„Ç§„É´„Éê„ÉÉ„ÉÜ„É™", cost: 3000 },
                    { id: 'reward_8', text: "ÁâπÂà•„Å™„Ç§„Éô„É≥„Éà", cost: 5000 },
                    { id: 'reward_9', text: "ÈùûÂ∏∏„Å´ÁâπÂà•„Å™„Ç§„Éô„É≥„Éà", cost: 10000 }
                ],
                history: [],
                dailyEarnings: {}, // Format: { "YYYY-MM-DD": points }
                taskHistory: []
            };

            let data = JSON.parse(localStorage.getItem('studentPointsData')) || defaultData;

            // Enforce fixed store items (Sync with latest defaultData)
            data.store = defaultData.store;

            // Ensure history exists (Migration)
            if (!data.history) data.history = [];
            if (!data.dailyEarnings) data.dailyEarnings = {};
            if (!data.taskHistory) data.taskHistory = [];

            // Fix for Feb 18th
            data.dailyEarnings['2026-02-18'] = 30;

            saveData();

            // --- DOM Elements ---
            const elements = {
                pointsDisplay: document.getElementById('points'),
                taskSelect: document.getElementById('task-select'),
                subTaskSelect: document.getElementById('sub-task-select'),
                taskDate: document.getElementById('task-date'),
                taskInput: document.getElementById('task-input'),
                taskValue: document.getElementById('task-value'),
                addTaskBtn: document.getElementById('add-task-btn'),
                taskList: document.getElementById('task-list'),
                bonusSelect: document.getElementById('bonus-select'),
                addBonusBtn: document.getElementById('add-bonus-btn'),
                storeGrid: document.getElementById('store-grid'),
                historyList: document.getElementById('history-list'),
                earningsChartCanvas: document.getElementById('earningsChart'),
                taskHistoryList: document.getElementById('task-history-list')
            };

            let earningsChart = null;

            // --- Core Functions ---

            function saveData() {
                localStorage.setItem('studentPointsData', JSON.stringify(data));
            }

            function renderAll() {
                renderPoints();
                renderTasks();
                renderStore();
                renderHistory();
                renderTaskHistory();
                renderGraph();
            }

            function renderPoints() {
                elements.pointsDisplay.textContent = data.points;
            }

            function renderTasks() {
                elements.taskList.innerHTML = '';
                data.tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'task-item';
                    li.innerHTML = `
                        <div class="task-info">
                            ${task.date ? `<span style="font-size: 0.85em; color: #888; margin-right: 8px;">${task.date}</span>` : ''}
                            ${task.text}
                            <span class="task-points">+${task.value}</span>
                        </div>
                        <button class="complete-btn" onclick="completeTask(${task.id})">‚úîÔ∏è „Åß„Åç„ÅüÔºÅ</button>
                        <button class="delete-btn" onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                    `;
                    elements.taskList.appendChild(li);
                });
            }

            function renderStore() {
                elements.storeGrid.innerHTML = '';
                data.store.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'store-item';

                    const canAfford = data.points >= item.cost;

                    div.innerHTML = `
                        <div class="store-info">
                            <strong>${item.text}</strong>
                            <span class="store-cost">-${item.cost} üíé</span>
                        </div>
                        <button class="redeem-btn" ${canAfford ? '' : 'disabled'} onclick="redeemItem('${item.id}')">
                            ${canAfford ? '‰∫§Êèõ„Åô„Çã' : '„Éù„Ç§„É≥„Éà‰∏çË∂≥'}
                        </button>
                    `;
                    elements.storeGrid.appendChild(div);
                });
            }

            function renderHistory() {
                elements.historyList.innerHTML = '';
                const sortedHistory = [...data.history].reverse(); // Show newest first

                if (sortedHistory.length === 0) {
                    elements.historyList.innerHTML = '<li style="text-align:center; color:#ccc; padding:10px;">„Åæ„Å†Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</li>';
                    return;
                }

                sortedHistory.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'history-item';

                    if (item.cost) {
                        li.innerHTML = `
                            <div>
                                <span class="history-date">${item.date}</span>
                                <span>${item.text}</span>
                            </div>
                            <span style="color: #FFB347; font-weight: bold;">-${item.cost}</span>
                        `;
                        elements.historyList.appendChild(li);
                    }
                });
            }

            function renderTaskHistory() {
                elements.taskHistoryList.innerHTML = '';
                const sortedHistory = [...data.taskHistory].reverse(); // Show newest first

                if (sortedHistory.length === 0) {
                    elements.taskHistoryList.innerHTML = '<li style="text-align:center; color:#ccc; padding:10px;">„Åæ„Å†„Çø„Çπ„ÇØÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</li>';
                    return;
                }

                sortedHistory.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'history-item'; // Reuse style
                    li.innerHTML = `
                        <div style="flex-grow: 1;">
                            <span class="history-date">${task.date}</span>
                            <span>${task.text}</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="color: #4CAF50; font-weight: bold; margin-right: 10px;">+${task.value}</span>
                            <button onclick="deleteHistoryItem(${task.id})" style="padding: 2px 6px; font-size: 0.8rem; background: #eee; color: #777;">üóëÔ∏è</button>
                        </div>
                    `;
                    elements.taskHistoryList.appendChild(li);
                });
            }

            window.deleteHistoryItem = function (id) {
                if (!confirm("Â±•Ê≠¥„Åã„Çâ„Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n(„Éù„Ç§„É≥„Éà„ÇÇÊ∏õÁÆó„Åï„Çå„Åæ„Åô)")) return;

                const index = data.taskHistory.findIndex(h => h.id === id);
                if (index === -1) return;

                const item = data.taskHistory[index];

                // Deduct points
                data.points -= item.value;
                if (data.points < 0) data.points = 0;

                // Deduct from Daily Earnings
                // Use rawDate if available, otherwise try to guess or ignore
                if (item.rawDate && data.dailyEarnings[item.rawDate]) {
                    data.dailyEarnings[item.rawDate] -= item.value;
                    if (data.dailyEarnings[item.rawDate] < 0) data.dailyEarnings[item.rawDate] = 0;
                }

                data.taskHistory.splice(index, 1);
                saveData();
                renderAll();
            }

            function renderGraph() {
                const ctx = elements.earningsChartCanvas.getContext('2d');

                // Prepare data for the current month
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth(); // 0-indexed
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const labels = [];
                const dataPoints = [];

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    labels.push(i); // Just the day number
                    dataPoints.push(data.dailyEarnings[dateStr] || 0);
                }

                if (earningsChart) {
                    earningsChart.destroy();
                }

                earningsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Áç≤Âæó„Éù„Ç§„É≥„Éà (Êó•)',
                            data: dataPoints,
                            backgroundColor: 'rgba(255, 154, 162, 0.6)', // Primary color with opacity
                            borderColor: 'rgba(255, 154, 162, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '„Éù„Ç§„É≥„Éà'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Êó•'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: `${year}Âπ¥${month + 1}Êúà„ÅÆ„Ç¨„É≥„Éê„É™Ë®òÈå≤ üìà`
                            }
                        }
                    }
                });
            }

            // --- Task Definitions ---
            const taskDefinitions = {
                "ÁÆóÊï∞": [
                    { name: "„Åè„ÇÇ„ÇìÁÆóÊï∞", points: 10 },
                    { name: "SapixÂü∫Á§é„Éà„É¨", points: 10 },
                    { name: "Sapix Daily", points: 10 }
                ],
                "ÂõΩË™û": [
                    { name: "Sapix Daily", points: 10 },
                    { name: "„Éà„ÉÉ„Éó„ÇØ„É©„Çπ", points: 10 },
                    { name: "‰ΩúÊñá", points: 20 }
                ],
                "Ëã±Ë™û": [
                    { name: "„Åè„ÇÇ„ÇìËã±Ë™û", points: 10 },
                    { name: "Ëã±Ê§úÁ∑¥Áøí", points: 10 }
                ],
                "Á§æ‰ºö": [
                    { name: "Sapix„ÉØ„Éº„ÇØ„Ç∑„Éº„Éà", points: 10 }
                ],
                "ÁêÜÁßë": [
                    { name: "Sapix„ÉØ„Éº„ÇØ„Ç∑„Éº„Éà", points: 10 }
                ]
            };

            // --- Actions ---

            window.addTask = function () {
                let text;
                const category = elements.taskSelect.value;

                if (elements.subTaskSelect.style.display !== 'none') {
                    text = elements.subTaskSelect.value;
                    // Prepare full text like "ÁÆóÊï∞: „Åè„ÇÇ„ÇìÁÆóÊï∞" or just the subtask name? 
                    // Let's us just the subtask name as requested, or maybe append category?
                    // User request: "Select Math -> show specific tasks".
                    // Let's use the subtask name directly.
                } else {
                    text = elements.taskInput.value.trim();
                }

                const value = parseInt(elements.taskValue.value);
                const date = elements.taskDate.value;

                if (!text || !value) {
                    alert("„Çø„Çπ„ÇØ„Å®„Éù„Ç§„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠ÔºÅ");
                    return;
                }

                const newTask = {
                    id: Date.now(),
                    text: text,
                    value: value,
                    date: date
                };

                data.tasks.push(newTask);
                saveData();
                renderAll(); // Renders chart too!

                // Reset logic based on current selection
                if (elements.subTaskSelect.style.display === 'none') {
                    elements.taskInput.value = (category === 'custom') ? '' : category;
                    // If custom, focus back
                    if (category === 'custom') elements.taskInput.focus();
                }
                // If subtask, maybe keep selection or reset? Let's keep selection for ease of multiple adds
            }

            // Bonus Definitions
            const bonusDefinitions = {
                "math_basic_perfect": { text: "ÁÆóÊï∞Âü∫Á§éÂïèÈ°åÊ∫ÄÁÇπ", points: 10 },
                "morning_study": { text: "ÊúùÂ≠¶Áøí", points: 20 },
                "homework_9pm": { text: "Â§ú9ÊôÇ„Åæ„Åß„Å´ÂÆøÈ°å„ÇíÂÖ®ÈÉ®ÂÆåÊàê", points: 20 },
                "sapix_c": { text: "Sapix C„ÇØ„É©„Çπ„Å´ÊòáÈÄ≤", points: 100 },
                "sapix_d": { text: "Sapix D„ÇØ„É©„Çπ„Å´ÊòáÈÄ≤", points: 300 },
                "sapix_alpha": { text: "Sapix Œ±„ÇØ„É©„Çπ„ÅÆË∫çÈÄ≤", points: 500 }
            };

            window.addBonus = function () {
                const key = elements.bonusSelect.value;
                const bonus = bonusDefinitions[key];

                if (!bonus) return;

                if (confirm(`„Äå${bonus.text}„Äç„Åß ${bonus.points} „Éù„Ç§„É≥„Éà„ÅÇ„Åí„Åæ„Åô„ÅãÔºü`)) {
                    // Add points
                    data.points += bonus.points;

                    // Track Daily Earnings
                    const targetDate = new Date().toISOString().split('T')[0];
                    if (!data.dailyEarnings[targetDate]) data.dailyEarnings[targetDate] = 0;
                    data.dailyEarnings[targetDate] += bonus.points;

                    // Add to Task History (as Bonus)
                    data.taskHistory.push({
                        id: Date.now(),
                        text: `üéâ ${bonus.text}`,
                        value: bonus.points,
                        date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric' }),
                        rawDate: targetDate
                    });

                    saveData();
                    renderAll();

                    // Animation
                    elements.pointsDisplay.parentElement.classList.add('anim-pop');
                    setTimeout(() => elements.pointsDisplay.parentElement.classList.remove('anim-pop'), 300);
                }
            }

            elements.addBonusBtn.addEventListener('click', addBonus);

            /*
             * Store Item Addition Logic Removed
             */

            window.completeTask = function (id) {
                const index = data.tasks.findIndex(t => t.id === id);
                if (index === -1) return;

                const task = data.tasks[index];
                const taskElement = elements.taskList.children[index];

                // Animate removal first
                taskElement.classList.add('anim-slide-out');

                // Add points animation
                elements.pointsDisplay.parentElement.classList.add('anim-pop');
                setTimeout(() => elements.pointsDisplay.parentElement.classList.remove('anim-pop'), 300);

                // Update data after animation starts
                setTimeout(() => {
                    // Points were already added on creation!
                    // data.points += task.value; 

                    // Add points NOW!
                    data.points += task.value;

                    // Track Daily Earnings (using today's date)
                    const targetDate = new Date().toISOString().split('T')[0];
                    if (!data.dailyEarnings[targetDate]) data.dailyEarnings[targetDate] = 0;
                    data.dailyEarnings[targetDate] += task.value;

                    // Add to Task History
                    // Use task.date, fallback to current time
                    let historyDate;
                    if (task.date) {
                        const d = new Date(task.date);
                        // Adjust for timezone offset if needed or use simple format
                        // Assuming simple YYYY-MM-DD input, let's show Month/Day
                        historyDate = `${d.getMonth() + 1}/${d.getDate()}`;
                    } else {
                        historyDate = new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }

                    data.taskHistory.push({
                        id: Date.now(),
                        text: task.text,
                        value: task.value,
                        date: historyDate
                    });

                    data.tasks.splice(index, 1);
                    saveData();
                    renderAll();

                    // Celebration if points reach milestone (optional polish)
                    console.log(`Task completed!`);
                }, 500); // Wait for slideOut animation
            }

            window.deleteTask = function (id) {
                if (!confirm("Êú¨ÂΩì„Å´„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÊ∂à„ÅôÔºü („Éù„Ç§„É≥„Éà„ÇÇÊ∏õ„Å£„Å°„ÇÉ„ÅÜ„Çà)")) return;

                const index = data.tasks.findIndex(t => t.id === id);
                if (index === -1) return;

                const task = data.tasks[index];

                // Deduct points
                // data.points -= task.value;
                // if (data.points < 0) data.points = 0;

                // Deduct from daily earnings if possible (Optional, but good for accuracy)
                // const targetDate = task.date || new Date().toISOString().split('T')[0];
                // if (data.dailyEarnings[targetDate]) {
                //     data.dailyEarnings[targetDate] -= task.value;
                //     if (data.dailyEarnings[targetDate] < 0) data.dailyEarnings[targetDate] = 0;
                // }

                // Animate removal first? simplified for now
                data.tasks.splice(index, 1);
                saveData();
                renderAll();
            }

            window.redeemItem = function (id) {
                const item = data.store.find(i => i.id === id);
                if (!item) return;

                if (data.points >= item.cost) {
                    if (confirm(`Êú¨ÂΩì„Å´„Äå${item.text}„Äç„Å®‰∫§Êèõ„Åô„ÇãÔºü (${item.cost} „Éù„Ç§„É≥„Éà)`)) {
                        data.points -= item.cost;


                        // Add to History
                        data.history.push({
                            id: Date.now(),
                            text: item.text,
                            cost: item.cost,
                            date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                        });

                        saveData();
                        renderAll();
                        alert(`„ÇÑ„Å£„Åü„Å≠ÔºÅ„Äå${item.text}„Äç„Å®‰∫§Êèõ„Åó„Åü„ÇàÔºÅüéâ`);
                    }
                } else {
                    alert("„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Å™„ÅÑ„Çà„ÄÅ„Åå„Çì„Å∞„Çç„ÅÜÔºÅ");
                }
            }

            // --- Backup & Restore ---
            window.exportData = function () {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `kira_task_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            window.importData = function (event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData && typeof importedData.points === 'number') {
                            if (confirm("„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆ„Åå„Çì„Å∞„ÇäË®òÈå≤„Åå„Ç§„É≥„Éù„Éº„Éà„Åó„ÅüÂÜÖÂÆπ„Å´ÁΩÆ„ÅçÊèõ„Çè„Çä„Åæ„Åô„ÄÇ")) {
                                data = importedData;
                                // Sync with latest constraints
                                data.store = defaultData.store;
                                if (!data.history) data.history = [];
                                if (!data.dailyEarnings) data.dailyEarnings = {};
                                if (!data.taskHistory) data.taskHistory = [];
                                saveData();
                                renderAll();
                                alert("„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ‚ú®");
                            }
                        } else {
                            alert("Ê≠£„Åó„ÅÑ„Éá„Éº„Çø„Éï„Ç°„Ç§„É´„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                        }
                    } catch (err) {
                        alert("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                        console.error(err);
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            // --- Event Listeners (Must be after function definitions) ---
            elements.addTaskBtn.addEventListener('click', window.addTask);

            document.getElementById('export-btn').addEventListener('click', window.exportData);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
            document.getElementById('import-file').addEventListener('change', window.importData);

            // Reset Logic
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm("„Äê„Å°„ÇÖ„ÅÜ„ÅÑ„Äë\n‰ªä„Åæ„Åß„ÅÆ„Åå„Çì„Å∞„Å£„Åü„Éù„Ç§„É≥„Éà„Å®„Çø„Çπ„ÇØ„ÅåÂÖ®ÈÉ®Ê∂à„Åà„Å°„ÇÉ„ÅÜ„ÇàÔºÅ\nÊú¨ÂΩì„Å´ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„ÅôÔºü")) {
                        data = {
                            points: 0,
                            tasks: [],
                            store: defaultData.store,
                            history: [],
                            dailyEarnings: {}
                        };
                        saveData();
                        renderAll();
                        alert("„É™„Çª„ÉÉ„Éà„Åó„Åü„ÇàÔºÅ„Åæ„Åü1„Åã„Çâ„Åå„Çì„Å∞„Çç„ÅÜÔºÅüöÄ");
                    }
                });
            }

            // Handle Task Selection Change
            elements.taskSelect.addEventListener('change', (e) => {
                const category = e.target.value;
                const subTasks = taskDefinitions[category];

                if (subTasks) {
                    // Show Sub-tasks
                    elements.taskInput.style.display = 'none';
                    elements.subTaskSelect.style.display = 'inline-block';
                    elements.subTaskSelect.innerHTML = '';

                    subTasks.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.name;
                        option.textContent = task.name;
                        option.dataset.points = task.points;
                        elements.subTaskSelect.appendChild(option);
                    });

                    // Set initial points for first item
                    if (subTasks.length > 0) {
                        elements.taskValue.value = subTasks[0].points;
                        // Prevent editing points for fixed tasks? User might want to adjust. allow edit.
                    }

                    // Style sub-task select to match input
                    elements.subTaskSelect.className = 'header-date'; // Reuse style or default
                    elements.subTaskSelect.style.padding = '12px';
                    elements.subTaskSelect.style.border = '2px solid #eee';
                    elements.subTaskSelect.style.borderRadius = '10px';
                    elements.subTaskSelect.style.fontSize = '1rem';
                    elements.subTaskSelect.style.outline = 'none';
                    elements.subTaskSelect.style.margin = '0'; // Reset headers margin

                } else {
                    // Show Text Input
                    elements.taskInput.style.display = 'inline-block';
                    elements.subTaskSelect.style.display = 'none';

                    if (category === 'custom') {
                        elements.taskInput.value = '';
                        elements.taskInput.focus();
                        elements.taskValue.value = 10;
                    } else {
                        elements.taskInput.value = category;
                        elements.taskValue.value = 10; // Default
                    }
                }
            });

            // Update points when sub-task changes
            elements.subTaskSelect.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const points = selectedOption.dataset.points;
                if (points) {
                    elements.taskValue.value = points;
                }
            });

            // Allow Enter key to trigger add
            elements.taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') window.addTask();
            });

            // --- Initialization ---
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            elements.taskDate.value = today;

            renderAll();
        });
    </script>
</body>

</html>
